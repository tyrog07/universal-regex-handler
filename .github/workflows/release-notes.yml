name: Release notes

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed

  workflow_dispatch: # Manual trigger option

jobs:
  generate-release-notes:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Read package.json version
        id: read_version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Generate Release Notes
        id: generate_release_notes
        uses: release-drafter/release-drafter@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-name: release-drafter.yml

      - name: Save Release Notes to File
        id: save_release_notes
        run: |
          echo "${{ steps.generate_release_notes.outputs.changelog }}" > RELEASE_NOTES.md
        shell: bash

      - name: Publish Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_NOTES=$(cat RELEASE_NOTES.md)
          curl -XPOST -H "Authorization: token $GITHUB_TOKEN" \
          -d "{\"tag_name\":\"${{ env.PACKAGE_VERSION }}\",\"name\":\"Release ${{ env.PACKAGE_VERSION }}\",\"body\":\"${RELEASE_NOTES}\",\"draft\":false,\"prerelease\":false}" \
          https://api.github.com/repos/${{ github.repository }}/releases
        shell: bash
